{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë¹„ì„œì™€ì˜ ëŒ€í™”</title>
    <link rel="stylesheet" href="{% static 'chat.css' %}">
    <style>
        #toggle-bgm-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'VT323', monospace;
            z-index: 101;
        }
        #bgm-volume-slider {
            position: absolute;
            top: 20px;
            left: 120px; /* Adjust as needed to position next to the button */
            width: 100px;
            z-index: 101;
            -webkit-appearance: none;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            height: 10px;
            outline: none;
        }
        #bgm-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }
        #bgm-volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }
        #feedback-container {
            position: absolute;
            bottom: 90px; /* Position above the dialogue box */
            left: 54%;
            transform: translateX(460px); /* Move it to the right of the dialogue box */
            z-index: 25;
            display: flex;
            gap: 10px;
        }
        .feedback-button {
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px solid #a9d1ff;
            color: white;
            font-size: 1.5em;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .feedback-button:hover {
            background-color: rgba(40, 40, 40, 0.9);
        }
    </style>
</head>
<body>
    <video autoplay muted loop class="background-video">
        <source src="{% static 'img/Main Room_.mp4' %}" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <button id="toggle-bgm-btn">BGM OFF</button>
    <input type="range" id="bgm-volume-slider" min="0" max="100" value="50">
    <div class="game-container">
        {% include 'includes/top_menu.html' with show_room_link=True %}

        <div class="character-container">
            <img id="chatbot-character" src="{% static 'img/char_default.png' %}" alt="AI ë¹„ì„œ">
            <div id="ai-emoticon-bubble" class="ai-emoticon-bubble" style="display: none;">
                <img id="ai-emoticon-img" src="" alt="AI Emoticon">
            </div>
        </div>

        <div class="dialogue-box">
            <div id="speaker-name">{{ user_profile.chatbot_name }}</div>
            <div id="dialogue-text">... (ì‚ë¹…) ... í¥, ë“œë””ì–´ ì™”ë„¤. ë­˜ ì‹œí‚¬ ì…ˆì´ì•¼?</div>
            <button id="prev-dialogue-button" class="dialogue-nav-button hidden">â–²</button>
        </div>

        <div id="feedback-container" style="display: none;">
            <button id="thumb-up-button" class="feedback-button">ğŸ‘</button>
            <button id="thumb-down-button" class="feedback-button">ğŸ‘</button>
        </div>

        <div id="preview-container" class="preview-container" style="display: none;">
            <img id="image-preview" src="" alt="Image Preview">
            <button id="clear-image-button" class="icon-button" title="ì´ë¯¸ì§€ ì§€ìš°ê¸°">&times;</button>
        </div>

        <div id="emoticon-preview-container" class="emoticon-preview-container" style="display: none;">
            <img id="emoticon-preview" src="" alt="Emoticon Preview">
            <button id="clear-emoticon-button" class="icon-button" title="ì´ëª¨í‹°ì½˜ ì§€ìš°ê¸°">&times;</button>
        </div>

        <div id="emoticon-palette" class="emoticon-palette" style="display: none;">
            <!-- Emoticons will be loaded here by JavaScript -->
        </div>
        
        <div id="chat-input-container" class="chat-input-container">
            <div class="chat-input">
                <input type="file" id="image-input" accept="image/*" style="display: none;">
                <button id="message-button" class="icon-button" title="ìª½ì§€ ë³´ë‚´ê¸°">âœ‰ï¸</button>
                <button id="unread-messages-button" class="icon-button" title="ì½ì§€ ì•Šì€ ìª½ì§€">
                    <span class="unread-indicator">{{ unread_friend_messages_count }}</span>
                </button>
                <button id="attach-image-button" class="icon-button" title="ì´ë¯¸ì§€ ì²¨ë¶€">ğŸ“</button>
                <button id="emoticon-button" class="icon-button" title="ì´ëª¨í‹°ì½˜ ì„ íƒ">ğŸ˜Š</button>
                <input type="text" id="user-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                <select id="friend-receiver-select" style="display: none;">
                    <option value="">ì¹œêµ¬ ì„ íƒ</option>
                </select>
                <input type="text" id="friend-message-input" placeholder="ì¹œêµ¬ì—ê²Œ ìª½ì§€ë¥¼ ë³´ë‚´ì„¸ìš”..." style="display: none;">
                <button id="send-button">ì „ì†¡</button>
                <button id="send-friend-message-button" style="display: none;">ìª½ì§€ ì „ì†¡</button>
                <div class="location-permission">
                    <input type="checkbox" id="location-checkbox">
                    <label for="location-checkbox">ìœ„ì¹˜ ì •ë³´ ì‚¬ìš©</label>
                </div>
            </div>
        </div>
    </div>

    {{ chat_messages|json_script:"chat_messages_data" }}
    <script>
        const chatHistory = JSON.parse(document.getElementById('chat_messages_data').textContent);
        const STATIC_URLS = {
            'ìƒê°': "{% static 'img/char_thinking.png' %}",
            'í–‰ë³µ': "{% static 'img/char_happy.png' %}",
            'ìŠ¬í””': "{% static 'img/char_sad.png' %}",
            'ë¶„ë…¸': "{% static 'img/char_angry.png' %}",
            'ë†€ëŒ': "{% static 'img/char_surprise.png' %}",
            'ê³µí¬': "{% static 'img/char_fear.png' %}",
            'í˜ì˜¤': "{% static 'img/char_disgust.png' %}",
            'ì¤‘ë¦½': "{% static 'img/char_default.png' %}",
            'default': "{% static 'img/char_default.png' %}"
        };
        const USERNAME = "{{ user.username }}";
        const USER_NICKNAME = "{{ user_profile.nickname|default:user.username|escapejs }}"; // Add this line
        const CHATBOT_NAME = "{{ user_profile.chatbot_name|escapejs }}";
        const affinityScore = "{{ user_profile.affinity_score|default:0 }}";
        const UNREAD_MESSAGE_COUNT = "{{ unread_friend_messages_count }}";
    </script>
    <audio id="bgm2" loop>
        <source src="{% static 'music/game_bgm.mp3' %}" type="audio/mpeg">
    </audio>

    <script src="{% static 'bgm.js' %}"></script>
    <script src="{% static 'chat.js' %}"></script>

</body>
</html>
